const rateLimitMap = new Map();
let cachedHeadlines = [];
let lastFetchTime = 0;

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    if (url.pathname === "/api/news") {
      const clientIP = request.headers.get("CF-Connecting-IP") || "unknown";
      const now = Date.now();

      // Rate limiting: 10/hr per IP
      const history = rateLimitMap.get(clientIP) || [];
      const recent = history.filter(ts => now - ts < 60 * 60 * 1000);
      if (recent.length >= 10) {
        return new Response(JSON.stringify({ error: "Rate limit exceeded: 10 requests/hr." }), {
          status: 429,
          headers: corsHeaders()
        });
      }
      rateLimitMap.set(clientIP, [...recent, now]);

      // Cache headlines for 10 min
      if (!cachedHeadlines.length || now - lastFetchTime > 10 * 60 * 1000) {
        try {
          const newsRes = await fetch("https://newsdata.io/api/1/news?country=us&language=en&category=top&apikey=REDACTED");
          const newsData = await newsRes.json();
          cachedHeadlines = newsData.results?.map(a => a.title).filter(Boolean).slice(0, 5) || [];
          lastFetchTime = now;
        } catch (e) {
          // Fallback: Try GNews
          const gnewsRes = await fetch("https://gnews.io/api/v4/top-headlines?lang=en&country=us&max=5&token=REDACTED");
          const gnewsData = await gnewsRes.json();
          cachedHeadlines = gnewsData.articles?.map(a => a.title).filter(Boolean).slice(0, 5) || ["Fallback headline"];
        }
      }

      // Step 2: Use OpenAI to rank by negativity
      const scored = await Promise.all(cachedHeadlines.map(async title => {
        try {
          const prompt = `Rate the emotional tone of this news headline from 1 (very negative) to 10 (very positive): "${title}"`;
          const res = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Authorization": `Bearer REDACTED`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: [{ role: "user", content: prompt }],
              temperature: 0.3,
              max_tokens: 10
            })
          });
          const data = await res.json();
          const score = parseInt(data.choices?.[0]?.message?.content?.trim()) || 5;
          return { title, score };
        } catch {
          return { title, score: 5 };
        }
      }));

      const mostNegative = scored.sort((a, b) => a.score - b.score)[0];

      // Step 3: Extract keywords from most negative
      const keywordPrompt = `Extract 3 important keywords from this headline for use in a news search: "${mostNegative.title}"`;

      const keywordRes = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": `Bearer REDACTED`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: keywordPrompt }],
          temperature: 0.3,
          max_tokens: 30
        })
      });

      const keywordText = await keywordRes.json();
      const keywords = keywordText.choices?.[0]?.message?.content?.trim().replace(/\s+/g, "+") || "community+response";

      // Step 4: Search NewsData.io for related positive articles
      let brightHeadline = "";
      try {
        const searchRes = await fetch(`https://newsdata.io/api/1/news?apikey=REDACTED&q=${keywords}&language=en&country=us`);
        const searchData = await searchRes.json();
        brightHeadline = searchData.results?.find(a => a.title)?.title || "";
      } catch {
        brightHeadline = "";
      }

      // Step 5: If nothing good found, fall back to GPT optimism
      let finalBright = brightHeadline;
      if (!brightHeadline) {
        const rewritePrompt = `Rewrite this headline in a more hopeful or constructive tone, while staying truthful:\n"${mostNegative.title}"`;

        const rewriteRes = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer REDACTED`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [{ role: "user", content: rewritePrompt }],
            temperature: 0.7,
            max_tokens: 60
          })
        });

        const rewriteData = await rewriteRes.json();
        finalBright = rewriteData.choices?.[0]?.message?.content?.trim() || "Could not generate optimism.";
      }

      return new Response(JSON.stringify({
        headline: mostNegative.title,
        bright: finalBright
      }), {
        headers: corsHeaders()
      });
    }

    return new Response("BrightSide Worker active!", {
      headers: { "Content-Type": "text/plain" }
    });
  }
};

function corsHeaders() {
  return {
    "Content-Type": "application/json",
    "Access-Control-Allow-Origin": "https://thebrightside-1.onrender.com"
  };
}
